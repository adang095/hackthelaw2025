<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Virtual Advocate: AI Legal Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* blue-600 */
        }
        .chat-bubble-ai {
            background-color: #E5E7EB; /* gray-200 */
        }
        .feedback-card {
            transition: all 0.3s ease-in-out;
        }
        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #feedback-panel .feedback-item, #chat-window > div {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9CA3AF;
            border-radius: 50%;
            display: inline-block;
            animation: wave 1.3s infinite;
        }
        .typing-indicator span:nth-of-type(2) {
            animation-delay: -1.1s;
        }
        .typing-indicator span:nth-of-type(3) {
            animation-delay: -0.9s;
        }
        @keyframes wave {
            0%, 60%, 100% {
                transform: initial;
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .form-label {
            font-weight: 600;
            color: #4B5563; /* gray-600 */
        }
        .form-input {
            width: 100%;
            border-gray-300;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }
        .form-input:focus {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* blue-600 with opacity */
             border-color: #3B82F6; /* blue-600 */
        }
        #summary-text-content {
             max-height: calc(100vh - 300px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="flex flex-col h-screen">
        
        <!-- Header -->
        <header class="bg-white shadow-md w-full p-4 flex items-center justify-between z-10">
            <div class="flex items-center">
                <i class="fas fa-balance-scale text-2xl text-blue-600 mr-3"></i>
                <h1 class="text-2xl font-bold text-gray-800">The Virtual Advocate</h1>
            </div>
            <button id="reset-simulation-btn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> New Scenario
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-grow overflow-y-auto p-4 md:p-8">

            <!-- Scenario Definition Screen -->
            <div id="scenario-definition" class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-2 text-center">Create Your Simulation</h2>
                <p class="text-gray-600 mb-8 text-center">Define the context and roles for your training session.</p>
                <form id="scenario-form" class="space-y-6 bg-white p-8 rounded-xl shadow-md">
                    <div>
                        <label for="user-role" class="form-label block mb-2">Your Role</label>
                        <input type="text" id="user-role" class="form-input" placeholder="e.g., A junior lawyer representing a software startup" required>
                    </div>
                    <div>
                        <label for="ai-persona" class="form-label block mb-2">AI's Role / Persona</label>
                        <input type="text" id="ai-persona" class="form-input" placeholder="e.g., An aggressive opposing counsel for a large corporation" required>
                    </div>
                    <div>
                        <label for="situation" class="form-label block mb-2">Situation / Objective</label>
                        <textarea id="situation" class="form-input" rows="4" placeholder="e.g., We are negotiating a crucial software licensing agreement. My goal is to secure a 3-year term and cap liability at $50,000. The AI will push for a 1-year term with unlimited liability." required></textarea>
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg">
                            Start Simulation <i class="fas fa-play ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Simulation Screen -->
            <div id="simulation-screen" class="hidden flex flex-col md:flex-row gap-6 max-w-7xl mx-auto h-full">
                <!-- Left Panel: Chat Interface -->
                <div class="flex flex-col w-full md:w-1/2 bg-white rounded-lg shadow-lg h-full">
                    <div class="p-4 border-b">
                        <h2 id="simulation-title" class="text-xl font-bold text-center"></h2>
                        <p id="simulation-objective" class="text-sm text-gray-600 text-center mt-1"></p>
                    </div>
                    <div id="chat-window" class="flex-grow p-4 overflow-y-auto">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <div id="typing-indicator" class="p-4 hidden">
                         <div class="flex items-center space-x-2">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <p class="text-sm text-gray-500">AI is thinking...</p>
                        </div>
                    </div>
                    <div id="input-area" class="p-4 border-t bg-gray-50 rounded-b-lg">
                        <div class="flex items-center">
                            <input type="text" id="user-input" class="w-full border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Type your response...">
                            <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg ml-3 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button id="end-simulation-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg ml-2 transition-colors">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Right Panel: Feedback -->
                <div class="w-full md:w-1/2 flex flex-col">
                     <div class="bg-white rounded-lg shadow-lg p-6 flex-grow flex flex-col">
                        <h3 class="text-2xl font-bold mb-4 text-center">Real-Time Feedback</h3>
                         <div id="feedback-panel" class="space-y-4 flex-grow">
                           <div class="text-center text-gray-500 italic pt-8">
                               Your feedback will appear here after you send a message.
                           </div>
                         </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const scenarioDefinition = document.getElementById('scenario-definition');
            const scenarioForm = document.getElementById('scenario-form');
            const simulationScreen = document.getElementById('simulation-screen');
            const chatWindow = document.getElementById('chat-window');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const endSimulationBtn = document.getElementById('end-simulation-btn');
            const feedbackPanel = document.getElementById('feedback-panel');
            const simulationTitle = document.getElementById('simulation-title');
            const simulationObjective = document.getElementById('simulation-objective');
            const resetBtn = document.getElementById('reset-simulation-btn');
            const typingIndicator = document.getElementById('typing-indicator');
            const inputArea = document.getElementById('input-area');

            // --- State Management ---
            let currentScenario = null;
            let conversationHistory = [];
            const apiKey = "AIzaSyAot2q61XrEfryJpvMm46SuTysPRiPSf1Y"; // API key is handled by the environment

            // --- Core Functions ---

            /**
             * Initializes a simulation based on user's custom scenario
             */
            async function startSimulation() {
                const userRole = document.getElementById('user-role').value;
                const aiPersona = document.getElementById('ai-persona').value;
                const situation = document.getElementById('situation').value;

                currentScenario = { userRole, aiPersona, situation };
                conversationHistory = [];

                // Update UI
                simulationTitle.textContent = "Live Simulation";
                simulationObjective.textContent = currentScenario.situation;
                scenarioDefinition.classList.add('hidden');
                simulationScreen.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
                inputArea.classList.remove('hidden');
                chatWindow.innerHTML = '';
                feedbackPanel.innerHTML = '<div class="text-center text-gray-500 italic pt-8">Your feedback will appear here after you send a message.</div>';
                
                setLoadingState(true, 'AI is preparing the scenario...');

                // Generate initial message from AI
                const initialPrompt = `You are a role-player in a legal simulation. Your persona is: ${aiPersona}. The user's role is: ${userRole}. The situation is: ${situation}. Based on this, provide a compelling opening statement to begin the conversation. Be concise and stay in character.`;
                
                try {
                    const initialMessage = await callGemini(initialPrompt, []);
                    addMessageToChat('ai', initialMessage);
                    conversationHistory.push({ role: "model", parts: [{ text: initialMessage }] });
                } catch (error) {
                    console.error("Error generating initial message:", error);
                    addMessageToChat('ai', "I'm sorry, I encountered an error setting up the scenario. Please try again.");
                } finally {
                    setLoadingState(false);
                }
            }
            
            function setLoadingState(isLoading, message = 'AI is thinking...') {
                 typingIndicator.querySelector('p').textContent = message;
                 if (isLoading) {
                     typingIndicator.classList.remove('hidden');
                     userInput.disabled = true;
                     sendBtn.disabled = true;
                     endSimulationBtn.disabled = true;
                 } else {
                     typingIndicator.classList.add('hidden');
                     userInput.disabled = false;
                     sendBtn.disabled = false;
                     endSimulationBtn.disabled = false;
                     userInput.focus();
                 }
            }
            
            function resetSimulation() {
                 currentScenario = null;
                 scenarioDefinition.classList.remove('hidden');
                 simulationScreen.classList.add('hidden');
                 resetBtn.classList.add('hidden');
                 scenarioForm.reset();
            }

            function addMessageToChat(sender, text) {
                const bubble = document.createElement('div');
                bubble.classList.add('p-3', 'rounded-lg', 'max-w-md', 'mb-2', 'shadow-sm');
                bubble.textContent = text;

                if (sender === 'user') {
                    bubble.classList.add('chat-bubble-user', 'text-white', 'self-end', 'ml-auto');
                } else {
                    bubble.classList.add('chat-bubble-ai', 'text-gray-800', 'self-start', 'mr-auto');
                }
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            
            function displayFeedback(feedback) {
                feedbackPanel.innerHTML = ''; 
                
                if (!feedback || !feedback.tone || !feedback.clarity || !feedback.empathy) {
                    feedbackPanel.innerHTML = `<div class="text-center text-red-500 italic pt-8">Could not generate feedback due to an issue. Please try another message.</div>`;
                    return;
                }

                const feedbackItems = [
                    { icon: 'fa-microphone-lines', title: 'Tone & Professionalism', score: feedback.tone.score, comment: feedback.tone.comment },
                    { icon: 'fa-bullseye', title: 'Clarity & Conciseness', score: feedback.clarity.score, comment: feedback.clarity.comment },
                    { icon: 'fa-handshake-angle', title: 'Empathy & Rapport', score: feedback.empathy.score, comment: feedback.empathy.comment },
                    { icon: 'fa-lightbulb', title: 'Strategic Suggestion', description: feedback.suggestion, value: 'Suggestion' }
                ];

                feedbackItems.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.classList.add('feedback-card', 'bg-gray-50', 'p-4', 'rounded-lg', 'border', 'border-gray-200', 'feedback-item');
                    card.style.animationDelay = `${index * 100}ms`;

                    const score = item.score;
                    const colorClass = score !== undefined ? (score > 7 ? 'text-green-600' : (score < 4 ? 'text-red-600' : 'text-yellow-600')) : 'text-blue-600';
                    
                    const explanationText = item.comment || item.description || '';

                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas ${item.icon} ${colorClass} text-xl mr-3"></i>
                                <h4 class="font-semibold">${item.title}</h4>
                            </div>
                            <span class="font-bold text-lg ${colorClass}">${score !== undefined ? `${score}/10` : item.value}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 pl-8">${explanationText}</p>
                    `;
                    feedbackPanel.appendChild(card);
                });
            }

            // --- Gemini API Integration ---

            async function callGemini(prompt, history) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [...history, { role: "user", parts: [{ text: prompt }] }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "Sorry, I received an unexpected response from the AI. Please try again.";
                }
            }

            async function getAIFeedback(userInputText) {
                const schema = {
                    type: "OBJECT",
                    properties: {
                        tone: { type: "OBJECT", properties: { score: { type: "INTEGER" }, comment: { type: "STRING" } } },
                        clarity: { type: "OBJECT", properties: { score: { type: "INTEGER" }, comment: { type: "STRING" } } },
                        empathy: { type: "OBJECT", properties: { score: { type: "INTEGER" }, comment: { type: "STRING" } } },
                        suggestion: { type: "STRING" }
                    },
                    required: ["tone", "clarity", "empathy", "suggestion"]
                };

                const feedbackPrompt = `You are an expert legal communication coach. Analyze the user's last message provided in the context of the legal simulation. Provide constructive feedback on Tone, Clarity, and Empathy/Rapport on a scale of 1-10, including a specific 'comment' explaining the score. Also provide a concise, actionable strategic suggestion for improvement.
                
                CONTEXT:
                - User's Role: ${currentScenario.userRole}
                - AI's Persona: ${currentScenario.aiPersona}
                - Situation: ${currentScenario.situation}
                - Conversation so far: ${JSON.stringify(conversationHistory.slice(-4))}
                
                Analyze this user message: "${userInputText}"`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: feedbackPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                 if (!response.ok) {
                    throw new Error(`API call for feedback failed with status: ${response.status}`);
                }
                
                const result = await response.json();

                 if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                } else {
                    console.error("Unexpected feedback API response structure:", result);
                    return null;
                }
            }

            /**
             * Downloads the final simulation summary as a PDF file.
             */
            function downloadPDFSummary() {
                const summaryTextElement = document.getElementById('summary-text-content');
                if (!summaryTextElement) {
                    console.error("Summary text element not found for download.");
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const rawText = summaryTextElement.innerText;
                const filename = `Virtual_Advocate_Summary.pdf`;

                // Main Title
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text("Virtual Advocate: Simulation Summary", 10, 20);
                
                // Situation / Objective
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Situation / Objective:", 10, 35);
                doc.setFont(undefined, 'normal');
                const situationLines = doc.splitTextToSize(currentScenario.situation, 180);
                doc.text(situationLines, 10, 42);

                let currentY = 42 + (situationLines.length * 7);
                doc.setDrawColor(180, 180, 180);
                doc.line(10, currentY, 200, currentY);
                currentY += 10;

                // Summary Content
                doc.setFontSize(11);
                const summaryLines = rawText.split('\n');

                summaryLines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '') {
                        currentY += 5;
                        return;
                    }

                    // Check if a line is a title (assuming titles end with a colon)
                    if (trimmedLine.endsWith(':')) {
                        doc.setFont(undefined, 'bold');
                        const splitTitle = doc.splitTextToSize(trimmedLine, 180);
                        doc.text(splitTitle, 10, currentY);
                        currentY += (splitTitle.length * 7);
                        doc.setFont(undefined, 'normal');
                    } else {
                        // Indent content under titles
                        const splitLine = doc.splitTextToSize(trimmedLine, 175); // slightly less width for indentation
                        doc.text(splitLine, 15, currentY);
                        currentY += (splitLine.length * 7);
                    }

                     if (currentY > 280) { // Page break logic
                        doc.addPage();
                        currentY = 20;
                    }
                });

                doc.save(filename);
            }
            
            // --- Event Listeners ---
            
            scenarioForm.addEventListener('submit', (e) => {
                e.preventDefault();
                startSimulation();
            });

            async function handleSendMessage() {
                const text = userInput.value.trim();
                if (text === '') return;

                addMessageToChat('user', text);
                conversationHistory.push({ role: "user", parts: [{ text }] });
                userInput.value = '';
                
                setLoadingState(true);

                try {
                    const responsePrompt = `You are a role-player in a legal simulation. Your persona is: ${currentScenario.aiPersona}. The user's role is: ${currentScenario.userRole}. The situation is: ${currentScenario.situation}. The conversation history is: ${JSON.stringify(conversationHistory.slice(-6))}. The user just said: "${text}". Respond concisely, in character.`;

                    const feedbackPromise = getAIFeedback(text);
                    const responsePromise = callGemini(responsePrompt, conversationHistory.slice(0, -1));

                    const [feedback, response] = await Promise.all([feedbackPromise, responsePromise]);
                    
                    displayFeedback(feedback);
                    
                    addMessageToChat('ai', response);
                    conversationHistory.push({ role: "model", parts: [{ text: response }] });

                } catch (error) {
                    console.error("Error during message handling:", error);
                    addMessageToChat('ai', "I'm sorry, I'm having trouble connecting to my services. Please try again in a moment.");
                    // Remove the last user message from history if the AI fails
                    conversationHistory.pop();
                } finally {
                    setLoadingState(false);
                }
            }

            async function endSimulation() {
                inputArea.classList.add('hidden'); // Hide input area
                feedbackPanel.innerHTML = `
                    <div class="text-center text-gray-500 italic pt-8">
                        <div class="flex justify-center items-center">
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                            <p class="ml-2">Generating final summary...</p>
                        </div>
                    </div>`;

                const summaryPrompt = `You are an expert legal training coach. Based on the entire conversation history, provide a final summary of the user's performance. The response should have sections like "Overall Strategy", "Consistency in Tone", and "Key Takeaways". Make these section titles bold by enclosing them in double asterisks, like **Overall Strategy:**.

                SCENARIO:
                - User's Role: ${currentScenario.userRole}
                - AI's Persona: ${currentScenario.aiPersona}
                - Situation: ${currentScenario.situation}

                FULL CONVERSATION HISTORY:
                ${JSON.stringify(conversationHistory)}
                `;

                try {
                    const summaryText = await callGemini(summaryPrompt, []);
                    feedbackPanel.innerHTML = ''; // Clear loading indicator
                    feedbackPanel.parentElement.querySelector('h3').textContent = "Final Simulation Summary";

                    // Format the summary text to convert markdown-like bolding and bullets to clean HTML
                    let formattedSummary = summaryText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Replace **text** with <strong>text</strong>
                        .replace(/\*/g, ''); // Remove all single asterisks

                    const summaryContainer = document.createElement('div');
                    summaryContainer.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg flex flex-col h-full';
                    
                    const summaryContent = document.createElement('div');
                    summaryContent.className = 'text-gray-700 whitespace-pre-wrap flex-grow overflow-y-auto pr-2';
                    summaryContent.id = 'summary-text-content';
                    summaryContent.innerHTML = formattedSummary;

                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0';
                    downloadBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Download as PDF';
                    downloadBtn.onclick = downloadPDFSummary;

                    summaryContainer.appendChild(summaryContent);
                    summaryContainer.appendChild(downloadBtn);
                    feedbackPanel.appendChild(summaryContainer);

                } catch (error) {
                     console.error("Error generating final summary:", error);
                     feedbackPanel.innerHTML = `<div class="text-center text-red-500 italic pt-8">Could not generate final summary. Please try a new scenario.</div>`;
                }
            }
            
            sendBtn.addEventListener('click', handleSendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !userInput.disabled) {
                    handleSendMessage();
                }
            });
            endSimulationBtn.addEventListener('click', endSimulation);

            resetBtn.addEventListener('click', resetSimulation);
        });
    </script>
</body>
</html>
